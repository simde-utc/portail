# API rights with OAuth
*(customized by Samy because he's a beast)*

## Quick presentation

A token is a triplet (`client`, `user`, `scopes`). This token is retrieved by an association's `client` (Which is an API, a Webwite, an Interface) or a user (connected user or personnal API). 

## Middleware

The Middleware:
- `auth:api` checks the connection by a client (association or personnal) linked to a user. 
- `auth.client` checks the connection by a client not linked to a user.
- `auth.any` checks the connection by a client connected or not to a user.

This middlewares are automatically generated by the `Scopes` facade.

## Scopes

Scopes define an authorized scope for a client. They allow a client to access or not a route/ressource depending on the required scopes for this given resource. 

### Scopes list depending on the routes

#### Scopes definition

`baseScope-verb-category` + (for each subcategory: `-subCategoryName`).
For example : `user-get-info`, `user-get-assos`, `user-get-assos-followed-now`

#### Base scopes definition

- **user** : An authentificated user is needed.
- **client** :  The application needs to have application rights independently of a user.

#### Verb definition

Actions have a classification and inherit their parents' rights.
- **manage**:  Whole resource management
    + **set** :  Possibility to write, update and delete data
        * **create**:  Create the associated data
        * **edit**:    Update the associated data
        * **remove**:  Delete the associated data
    + **get** :  Read-only retrievement.

### Facades

The `Scopes` facade simplifies Scopes usage.

These methods generate required middlewares on demand. 

- `matchAnyUser()`: Authorizes only user-associated clients.
- `matchAnyClient()`: Authorizes only non-user-associated clients.
- `matchAnyUserOrClient()`: Authorizes only connected clients.
- `match($scopes, array $scopes2)`: Detects depeding on the given args:
  - If `$scopes` is of type `string`: returns `matchOne($scopes)`
  - If `$scopes` is of type `array` : returns `matchAll($scopes, $scopes)`
- `matchOne($scopes)`: Authorizes only if the client has one scope of the given list or their child (Considering verb inheritance). 
- `matchAll(array $scopes, array $scopes2)`: Authorizes only if the client has all scope of the two given lists.

Some similar functions return an boolean instead of authorizing trough some middlewares. 

### Scopes usage in the portal's controllers

Example :

```php

class RessourceController extends Controller {
    /**
     * Scopes Ressource
     *
     * <Function description>
     */
    public function __construct() {
        $this->middleware(\Scopes::matchOne(
            ['client-get-articles-public', 'user-get-articles-followed-now', 'user-get-articles-done-now']), 
            ['only' => ['index', 'show']]
        );
        $this->middleware(\Scopes::matchAll(
            ['user-manage-groups']), 
            ['only' => ['store', 'update', 'destroy']]
        );
    }

    // ...
}
```
