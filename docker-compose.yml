version: '3.7'

volumes:
  dbdata:

services:

  # The Back-End Application (Laravel)
  back:
    build:
      context: docker/configurations/back
      args:
        USER_ID: ${USER_ID:-0}
        GROUP_ID: ${GROUP_ID:-0}
    working_dir: /var/www/html
    volumes:
      - ./:/var/www/html
      - /var/www/html/vendor # FIME : Share dependencies with the host ? Comment to enable.
    depends_on:
      - database
    env_file:
      - .env
    environment:
      "DB_HOST": "database"
      "APP_KEY": "base64:zJQUL4236152JL697IJ+1UO7IUS42w2Td4069LNABfE="

  # The Front-End Bundler (Webpack)
  front:
    build:
      context: docker/configurations/front
      args:
        USER_ID: ${USER_ID:-0}
        GROUP_ID: ${GROUP_ID:-0}
    working_dir: /app
    volumes:
      - ./:/app
      - /app/node_modules # FIME : Share dependencies with the host ? Comment to enable.
    env_file:
      - .env
    environment:
      NODE_OPTIONS: "--openssl-legacy-provider"
    # TODO: upgrade webpack so that we can remove this option allowing the usage of deprecated crypto

  # The Reverse Proxy (Nginx)
  proxy:
    image: nginx:stable
    volumes:
      - ./:/var/www/html
      - ./docker/configurations/proxy/vhost.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - 8000:80
    env_file:
      - .env
    depends_on:
      - back

  # The Database (MySQL)
  database:
    image: mysql:5.6
    volumes:
      - dbdata:/var/lib/mysql
    environment:
      - MYSQL_ROOT_PASSWORD=toor
      - MYSQL_USER=portail
      - MYSQL_PASSWORD=password
      - MYSQL_DATABASE=portail
